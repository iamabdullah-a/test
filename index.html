<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Enterprise WebAR — MindAR + A-Frame</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Local A-Frame -->
  <script src="./assets/aframe.min.js"></script>

  <!-- Local MindAR (Image Tracking for A-Frame) -->
  <script src="./assets/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      color: #fff;
      z-index: 10;
    }
    #loading.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div id="loading">Loading AR…</div>

  <a-scene
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    renderer="
      physicallyCorrectLights: true;
      colorManagement: true;
      toneMapping: ACESFilmic;
      outputEncoding: sRGBEncoding;
    "
    mindar-image="
      imageTargetSrc: ./targets.mind;
      filterMinCF: 0.001;
      filterBeta: 0.01;
    "
  >
    <!-- Camera -->
    <a-camera
      position="0 0 0"
      look-controls="enabled: false"
    ></a-camera>

    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.35"></a-entity>

    <a-entity
      light="type: directional; intensity: 1.1; castShadow: true"
      position="1 3 2"
    ></a-entity>

    <!-- Image Target Anchor -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- Smoothed World-Space Anchor -->
      <a-entity id="anchor" pose-smoother>
        <!-- Product Model -->
        <a-entity
          gltf-model="./model.glb"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.5 0.5 0.5"
          shadow="cast: true; receive: false"
        ></a-entity>

        <!-- Shadow Catcher -->
        <a-plane
          rotation="-90 0 0"
          width="1.2"
          height="1.2"
          material="
            shader: shadow;
            opacity: 0.35;
          "
          shadow="receive: true"
        ></a-plane>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    AFRAME.registerComponent('pose-smoother', {
      schema: {
        positionLerp: { default: 0.15 },
        rotationLerp: { default: 0.2 }
      },

      init() {
        this.visible = false;
        this.targetPosition = new THREE.Vector3();
        this.targetQuaternion = new THREE.Quaternion();

        this.el.object3D.visible = false;

        this.el.addEventListener('targetFound', () => {
          this.visible = true;
          this.el.object3D.visible = true;
        });

        this.el.addEventListener('targetLost', () => {
          this.visible = false;
        });
      },

      tick() {
        if (!this.visible) return;

        const obj = this.el.object3D;
        obj.getWorldPosition(this.targetPosition);
        obj.getWorldQuaternion(this.targetQuaternion);

        obj.position.lerp(this.targetPosition, this.data.positionLerp);
        obj.quaternion.slerp(this.targetQuaternion, this.data.rotationLerp);
      }
    });

    const sceneEl = document.querySelector('a-scene');
    const loadingEl = document.getElementById('loading');

    sceneEl.addEventListener('loaded', () => {
      loadingEl.classList.add('hidden');
    });
  </script>
</body>
</html>
